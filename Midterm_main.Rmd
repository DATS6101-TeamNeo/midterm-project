---
title: "Effect of Major Historical Events on S&P500 Index"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r init, include=FALSE}
# Load all required packages
library(dplyr)
library(ggplot2)
library(ezids)
library(lubridate)
library(corrplot)
knitr::opts_chunk$set(warning = F, results = "markup", message = F)
options(scientific=T, digits = 3) 
```



# Team Neo Midterm Project

Terminology in Trading

+ "open" - The opening price for the specified date(s).
+ "close" - The closing price for the specified date(s).
+ "high" - The high price for the specified date(s).
+ "low" - The low price for the specified date(s).
+ "volume" - The volume for the specified date(s).
+ "change" - The price change since the previous trading weekly close.
             (For monthly take previous trading month’s close and for daily take previous
             trading day’s close.)


We are analyzing how major historical events impacted the S&P 500 index using daily data in last 20 years, that is from 2003-2023. Specifically, we will:

1. Examine the daily closing prices of the index to see how events affected the price levels.

2. Calculate and analyze the daily returns and standardized daily returns to understand volatility around events. 

3. Study the correlation between different variables in the dataset to identify relationships.

4. Plot the daily returns, standardized returns, and closing prices around major events to visualize the impacts.

5. Remove outliers from the data and re-analyze to ensure robustness of our findings.

By looking at prices, returns, correlations, visualizations, and handling outliers, we aim to comprehensively assess how significant historical occurrences influenced the behavior of the S&P 500 index over this 20-year period.




```{r, include=T, results=T}
df <- data.frame(read.csv('dataset2003-2023.csv'))
df$Date <- as.Date(df$Date)
str(df)
new_df <- subset(df, select = -c(6))
str(new_df)
summary(new_df)
num_variables <- subset(new_df,select = -c(1))
head(num_variables)
```

First we change the data type for date column as Date.
Further we drop adjusted close column as we already had similar column named close and we wanted to work with the raw data.



```{r, include=T, results=T}
corr_matrix <- cor(num_variables)
corrplot(corr_matrix)
corr_matrix
```
The correlation plot shows that we have weak positive correlation of open high low and close variables with Volume variable.
From the correlation matrix, we can see that the closing price is highly correlated with the high price and low price. This is expected as the all of these prices are related to each other. For example,

- The closing price is correlated to opening price.
- The highest and lowest prices are correlated to the opening and closing prices.

```{r, include=T, results=T}
new_df$daily_change <- (new_df$Close / lag(new_df$Close) - 1) * 100

head(new_df)
```
The code computes the daily returns for the S&P 500 index. The daily returns are calculated as the percentage change in the closing price from the previous day. We will use these daily returns to analyze the volatility of the index around major events.

```{r, include=T, results=T}
new_df2 <- na.omit(new_df)

qqnorm(new_df2$daily_change, main = "Q-Q Plot of Daily Returns")
qqline(new_df2$daily_change, col = "red") # Add reference line

```

From the Q-Q plot, we can see that the daily returns are normally distributed with deviations at the ends which is caused due to outliers. Let's now plot the histogram of the daily returns to further confirm this.


```{r, include=T}
# hist(new_df2$daily_change_standardized, breaks = 50, col = 'green', main = "Histogram daily returns standardized distribution",xlab = "daily returns")
hist(new_df2$daily_change, breaks = 100, col = 'green', main = "Histogram daily returns distribution",xlab = "daily returns")
```
As we observe the bell curve in the histogram, we can confirm that the daily returns are normally distributed.

The significance of this output lies in visualizing the distribution of daily percentage changes in the S&P 500 index. The histogram provides insights into the frequency and magnitude of daily returns, allowing us to assess the volatility, risk, and potential patterns in the stock market. Green color is used for the bars in the histogram, but you can modify the color (col) parameter to any other color if desired.

```{r, include=T}
plot(new_df2$Date, new_df2$Close, type = "l", col = "blue", xlab = "Date", ylab = "Close", main = "Close of S&P500 Index")
```

The graph visually represent the historical trend of the S&P 500 index closing values over time. By plotting the data as a line graph, I can observe the overall direction of the index (whether it's trending upwards, downwards, or relatively stable) and identify periods of significant movement or volatility.

```{r, include=TRUE, results=T}

# Define the event windows
great_recession_start <- as.Date("2007-12-31")
great_recession_end <- as.Date("2009-06-30")

covid_start <- as.Date("2020-02-03")
lockdown_end <- as.Date("2020-08-31")
covid_end <- as.Date("2023-05-11")

russia_ukraine_start <- as.Date("2022-02-24")
russia_ukraine_end <- Sys.Date()  # Current date

# Subset the data for each event window
great_recession_data <- new_df2 %>%
  filter(Date >= great_recession_start & Date <= great_recession_end)

covid_data <- new_df %>%
  filter(Date >= covid_start & Date <= covid_end)

russia_ukraine_data <- new_df2 %>%
  filter(Date >= russia_ukraine_start & Date <= russia_ukraine_end)

# Visualize daily returns for each event
ggplot(great_recession_data, aes(x = Date, y = daily_change)) +
  geom_line() +
  xlab("Date") +
  ylab("Daily Returns (%)") +
  ggtitle("S&P 500 Daily Returns during Great Recession")

ggplot(covid_data, aes(x = Date, y = daily_change)) +
  geom_line() +
  xlab("Date") +
  ylab("Daily Returns (%)") +
  ggtitle("S&P 500 Daily Returns during COVID-19 Pandemic")

ggplot(russia_ukraine_data, aes(x = Date, y = daily_change)) +
  geom_line() +
  xlab("Date") +
  ylab("Daily Returns (%)") +
  ggtitle("S&P 500 Daily Returns during Russia-Ukraine Invasion")

# Defining a function to compute summary statistics
compute_summary <- function(data) {
  data %>%
    summarize(mean_return = mean(daily_change, na.rm = TRUE),
              median_return = median(daily_change, na.rm = TRUE),
              max_return = max(daily_change, na.rm = TRUE),
              min_return = min(daily_change, na.rm = TRUE))
}

# Apply the function to each event data
great_recession_summary <- compute_summary(great_recession_data)
covid_summary <- compute_summary(covid_data)
russia_ukraine_summary <- compute_summary(russia_ukraine_data)

```
The above code calculates the daily returns for the S&P 500 index during the Great Recession, COVID-19 pandemic, and Russia-Ukraine invasion. The daily returns are calculated as the percentage change in the closing price from the previous day. We then visualize the daily returns for each event using line plots(time period is different for each of these events, so we drew separate graphs) and compute summary statistics to understand the volatility of the index around these events.

The COVID-19 Virus end date used is the one officially declared by the [cdc.gov](https://www.cdc.gov/coronavirus/2019-ncov/your-health/end-of-phe.html)

```{r, include=TRUE, results=T}
# Subset the data for the specified periods
pre_recession <- new_df2 %>%
  filter(Date >= as.Date("2003-01-01") & Date <= (great_recession_start - days(1)))

during_recession <- new_df2 %>%
  filter(Date >= great_recession_start & Date <= great_recession_end)

post_recession <- new_df2 %>%
  filter(Date >= (great_recession_end + days(1)) & Date <= as.Date("2019-12-31"))

# Define a function to calculate yearly returns
calculate_yearly_returns <- function(data) {
  data %>%
    mutate(Year = format(Date, "%Y")) %>%
    group_by(Year) %>%
    summarize(start_price = first(Close),
              end_price = last(Close),
              yearly_return = (end_price - start_price) / start_price * 100)
}

# Apply the function to each period data
pre_recession_yearly_returns <- calculate_yearly_returns(pre_recession)
during_recession_yearly_returns <- calculate_yearly_returns(during_recession)
post_recession_yearly_returns <- calculate_yearly_returns(post_recession)

# Compare summary statistics (e.g., mean yearly returns)
mean(pre_recession_yearly_returns$yearly_return)
mean(during_recession_yearly_returns$yearly_return)
mean(post_recession_yearly_returns$yearly_return)

# Visualize yearly returns
ggplot() +
  geom_bar(data = pre_recession_yearly_returns, aes(x = Year, y = yearly_return), stat = "identity", fill = "steelblue") +
  geom_bar(data = during_recession_yearly_returns, aes(x = Year, y = yearly_return), stat = "identity", fill = "firebrick") +
  geom_bar(data = post_recession_yearly_returns, aes(x = Year, y = yearly_return), stat = "identity", fill = "forestgreen") +
  xlab("Year") +
  ylab("Yearly Return (%)") +
  ggtitle("S&P 500 Yearly Returns") +
  scale_x_discrete(limits = unique(c(pre_recession_yearly_returns$Year, during_recession_yearly_returns$Year, post_recession_yearly_returns$Year))) +
  theme_minimal()
```
The code calculates the yearly returns for the S&P 500 index before, during, and after the Great Recession. The yearly returns are calculated as the percentage change in the closing price from the beginning to the end of each year. We then compare the mean yearly returns for each period and visualize the yearly returns using bar plots to understand the performance of the index around the Great Recession.

